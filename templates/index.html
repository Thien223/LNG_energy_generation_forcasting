<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>안동 발전소 입찰 시스템</title>
    <!-- <meta http-equiv="refresh" content="3600"> -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="static/css/stylesheet.css"/>
    <link rel="stylesheet" href="static/css/jquery-ui.css"/>
    <script src="static/js/jquery-1.12.4.js"></script>
    <script src="static/js/jquery-ui.js"></script>
    <script src="static/js/setOperations.js"></script>
	<script src="static/highcharts_modules/jquery.min.js"></script>
	<script src="static/highcharts_modules/highcharts.js"></script>
	<script src="static/highcharts_modules/highcharts-more.js"></script>
	<script src="static/highcharts_modules/data.js"></script>
	<script src="static/highcharts_modules/series-label.js"></script>
	<script src="static/highcharts_modules/export-data.js"></script>
	<script src="static/highcharts_modules/exporting.js"></script>
	<script src="static/highcharts_modules/es6-promise.min.js" integrity="sha256-45YA33UQCDcJsntBst2bhka2t/LBNHP7RNvpllHPkQ0=" crossorigin="anonymous"></script>
    <script src="static/highcharts_modules/es6-promise.auto.min.js" integrity="sha256-OI3N9zCKabDov2rZFzl8lJUXCcP7EmsGcGoP6DMXQCo=" crossorigin="anonymous"></script>
	<script src="static/highcharts_modules/fetch.min.js" integrity="sha256-eOUokb/RjDw7kS+vDwbatNrLN8BIvvEhlLM5yogcDIo=" crossorigin="anonymous"></script>
	<script src="static/highcharts_modules/d3-dsv.v1.min.js"></script>
    <script src="static/highcharts_modules/d3-fetch.v1.min.js"></script>
<script>
    String.prototype.includes = function (str) {
        var returnValue = false;

        if (this.indexOf(str) !== -1) {
            returnValue = true;
        }

        return returnValue;
    };
    Array.prototype.indexOfDate = function(date){
        for (var i = 0; i < this.length; i++){
            if (+this[i] === +date) return i;
        };
        return -1;
    };
    /// show context menu:
    $(document).bind("contextmenu", function(event) { 
        $("div.custom-menu").hide();
        if(event.pageX>520 && event.pageX <1800 && event.pageY>90 && event.pageY<300){
            event.preventDefault();
            $("<div class='custom-menu'>원본 데이터 출력</div>")
            .appendTo("body")
            .css({top: event.pageY + "px", left: event.pageX + "px"});
        }
        $("div.custom-menu").click(function() {
            $("div.custom-menu").hide();
            ////////////////////////////////////////////// check data existance
            if(data==null){
                alert("먼저 산출하세요!");
            }else{
                var selected_date = document.getElementById("date-select").value.replace(/-/g,"")
                var filename = "원본 산출 데이터_" + selected_date + ".csv";
                exportOriginalData(data, temperature_col, filename);
            }
                
            
        });
    });
    $(document).bind("click", function(event) { $("div.custom-menu").hide();});
    
    function exportTableToCSV($table,temperature_col, filename) {
        var $rows = $table.find('tr:has(td)');
        ///keep 3 first rows only (송전단 과 시간 행)
        $rows = $rows.slice(0,3);
            // Temporary delimiter characters unlikely to be typed by keyboard
            // This is to avoid accidentally splitting the actual contents
            tmpColDelim = String.fromCharCode(11), // vertical tab character
            tmpRowDelim = String.fromCharCode(0), // null character
            // actual delimiter characters for CSV format
            colDelim = '","',
            rowDelim = '"\r\n"',
            csv = '';
            // Grab text from table into CSV formatted string
            csv = csv + $rows.map(function (i, row) {
                var $row = $(row), $cols = $row.find('td');
                if(i==0){
                    $cols = $cols.slice(2);
                    return $cols.map(function (j, col) {
                        var $col = $(col);
                        if(!$col.text().includes("+") && !$col.text().includes("-"))
                            var text = '[*'+$col.text()+']';//+colDelim+ temperature_col[i];
                        else{
                            var text = '['+$col.text()+']';//+colDelim+ temperature_col[i];
                        }
                        // return text.replace(/"/g, '""'); // escape double quotes
                        return text; // escape double quotes
                    }).get().join(tmpColDelim);
                }else{
                    return $cols.map(function (j, col) {
                        var $col = $(col), text = $col.text();
                        // return text.replace(/"/g, '""'); // escape double quotes
                        return text; // escape double quotes
                    }).get().join(tmpColDelim);
                }
            }).get().join(tmpRowDelim)
                .split(tmpRowDelim).join(rowDelim)
                .split(tmpColDelim).join(colDelim) + '"';

            /// because the table is in horizontal, we need converting to vertical direction
            ///convert temperature array to string
            temperature_col = temperature_col.map(function(number){
                return parseFloat((Math.round(number*10)/10).toFixed(1));
            });
            var string_temp = JSON.stringify(temperature_col);
            /// add quotes
            string_temp = string_temp.replace(/,/g,'","').replace("[",'"').replace("]",'"');
            /// split csv data
            var csv_list = csv.split("\r\n");
            //add temperature column into 2nd index
            csv_list.splice(1,0,string_temp);
            
            //swap row and column of csv data, add column title
            csv_='"거래시간","온도","GT가용량","CC가용량"\r\n"';
            ///keep only 송전량 데이터 (title and 2 first rows)
            for(i=0;i<34;i++){
                csv_ += csv_list[0].split(',')[i] +','+ csv_list[1].split(',')[i] + ','+csv_list[2].split(',')[i] + ','+csv_list[3].split(',')[i]+'\r\n';
            }
            // Data URI
            // remember to add \uFEFF char befor csv series
            csvData ='data:application/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv_);
            if (window.navigator.msSaveBlob) { // IE 10+
                //alert('IE' + csv);
                window.navigator.msSaveOrOpenBlob(new Blob(['\uFEFF' + csv_], {type: "text/csv;charset=utf-8;"}), filename)
            } 
            else {
                $(this).attr({ 'download': filename, 'href': csvData, 'target': '_blank' }); 
            }
        }



    function exportOriginalData(data, temperature_col, filename) {
        var t_ = '[-1801]","[-1901]","[-2001]","[-2101]","[-2201]","[-2301]","[*0001]","[*0101]","[*0201]","[*0301]","[*0401]","[*0501]","[*0601]","[*0701]","[*0801]","[*0901]","[*1001]","[*1101]","[*1201]","[*1301]","[*1401]","[*1501]","[*1601]","[*1701]","[*1801]","[*1901]","[*2001]","[*2101]","[*2201]","[*2301]","[+0001]","[+0101]","[+0201]","[+0301]"'
        temperature_col = temperature_col.map(function(number){
            return parseFloat((Math.round(number*10)/10).toFixed(1));
        });
        var string_temp = JSON.stringify(temperature_col);
        /// add quotes
        string_temp = string_temp.replace(/,/g,'","').replace("[",'"').replace("]",'"');


        //swap row and column of csv data, add column title
        csv_='"거래시간","온도","송전 GT가용량","송전 CC가용량","발전 GT가용량","발전 CC가용량"\r\n"';
        ///keep only 송전량 데이터 (title and 2 first rows)
        for(i=0;i<34;i++){
            csv_ += t_.split(',')[i]+','+ string_temp.split(',')[i] + ',"'+data.gt_transfer_predicted[i] + '","'+data.cc_transfer_predicted[i]+'","'+data.gt_generate_predicted[i]+'","'+data.cc_generate_predicted[i]+'"\r\n';
        }
        csvData ='data:application/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv_);
        if (window.navigator.msSaveBlob) { // IE 10+
            //alert('IE' + csv);
            window.navigator.msSaveOrOpenBlob(new Blob(['\uFEFF' + csv_], {type: "text/csv;charset=utf-8;"}), filename);
        } 
        else {
            downloadURI(csvData,filename);
        }

        
    }


        
    var temperature_col;
    var data;
    var current_tab = "gt";
    var pressure = [];
    var gt_generate_name_list = [];
    var cc_generate_name_list = [];
    var gt_send_name_list = [];
    var cc_send_name_list = [];
    var _suffix=['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','33','34'];
    _suffix.forEach(function(element){
        gt_generate_name_list.push("#generated-power-gt--" + element);
        cc_generate_name_list.push("#generated-power-cc--" + element);
        gt_send_name_list.push("#send-power-gt--" + element);
        cc_send_name_list.push("#send-power-cc--" + element);       
    });
    ///read csv file, add random number to prevent caching the file
    d3.csv("static/data/inlet_clean_info.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
        var today = new Date();
        var clean_time = data[0].cleaned_time;
        //display info on site
        $("#nearest_cleaned_time").html(clean_time);
        var clean_time = data[0].cleaned_time.replace(/-/g,"/");
        clean_time = new Date(clean_time);
        var hours = Math.abs(today - clean_time) / 36e5;
        hours = Math.round(hours);
        $("#EOH").html(hours);
        var tested_power = data[0].tested_power_output;
        tested_power = Math.floor(tested_power*1000)/1000;
        $("#test_power").html(tested_power);
    });
    //// remove duplicate elements from an array, return it's sub array
    function removeDups(array) {
        let unique = {};
        array.forEach(function(i) {
            if(!unique[i]) {unique[i] = true;}
        });
        return Object.keys(unique)
    };

    ///simple function to clear html table content
    function reset_table(){
        $('#form').find('input, textarea').not("#txt-cleaned-time").val('');
        for(i=0;i<34;i++){
            $(gt_generate_name_list[i]).html(" ");
            $(cc_generate_name_list[i]).html(" ");
            $(gt_send_name_list[i]).html(" ");
            $(cc_send_name_list[i]).html(" ");
        };
    };
    //// make to tab button (GT,CC) to be activated
    function activeTabButton(evt, buttonName) {
        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" tab-button-active", "");
        }
        evt.currentTarget.className += " tab-button-active";
    };
    ////// function to download file
    function downloadURI(uri, name) 
    {
        var link = document.createElement("a");
        link.download = name;
        link.href = uri;
        link.click();
    }
    $(function(){
        $("#dnl-template").click(function(){
            downloadURI('static/data_templates/templates.zip', 'templates.zip');
        });
    });
    
    
    $(function(){
        $("#csv").click(function(){
            document.getElementById("file").click();
        });
    });
    ///// trigger '산출' button to calculate
    $(function(){
        $('#ml-form_submit').click(function(){
            $("#warning-message").html("");
            if(form_validation()==true){
                // var user = $('#inputUsername').val();
                // var pass = $('#inputPassword').val();
                $.ajax({
                    url: '/ml-inference',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response){
                        /////////// successfully calculated/////////////////
                        data = JSON.parse(response);
                        temperature_col =  data.temperature;
                        // .map(function (num){
                        //     return parseFloat(Math.round(num);
                        // });
                        for(i=0;i<34;i++){
                            $(gt_generate_name_list[i]).html(Math.round(data.gt_generate_predicted[i]));
                            $(cc_generate_name_list[i]).html(Math.round(data.cc_generate_predicted[i]));
                            $(gt_send_name_list[i]).html(Math.round(data.gt_transfer_predicted[i]));
                            $(cc_send_name_list[i]).html(Math.round(data.cc_transfer_predicted[i]));
                             /// returned pressure is a number, convert to array for plotting graph
                             pressure.push(data.pressure);
                        };
                        
                        if (current_tab=="gt"){
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
                            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }else{
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
                            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }
                    },
                    error: function(error){
                        if (error.status == 500){
                            alert("산출 실패하였습니다. 오류: 500 파일 존재하지 않습니다. 업데이트 필요합니다. ");
                        }else{
                            alert("산출 실패하였습니다. 오류: " + (error.statusText));
                        }
                        
                    }
                });
            }

        });
    });
    //// handling of date dropdown listbox changed 
    $(function(){   
        $("#date-select").change(function(){
            data = null;
            ///clear message
            $("#warning-message").html("");
            temperature_col = null;
            ////get tempearture input textbox html element (to assign values or remove values latter)
            var txts = document.getElementsByClassName("temperature-input-textbox");
            document.getElementById("txt-pressure").value="";
            for(i=0;i<txts.length;i++){
                txts[i].value="";
            }
            var select_element = document.getElementById("date-select");
            var opt = select_element.value;
            var temps=[];
            var opt_date = new Date(opt.replace(/-/g,"/"));
            var flag=false;
            ///read temperature file to fill up the input textbox of temperature
            d3.csv("static/data/temperature.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
                var temps=[];
                var press_;
                var opt_date = new Date(opt.replace(/-/g,"/"));
                var weekday = (new Date()).getDay();
                for (i=0;i<data.length;i++){
                    time_in_data = new Date(data[i].time.replace(/-/g,"/"));
                    if ((time_in_data - opt_date) / 36e5 / 24 ==0){
                        press_=data[i].pressure;
                        temps.push(data[i].yes_15);
                        temps.push(data[i].yes_18);
                        temps.push(data[i].yes_21);
                        temps.push(data[i].tod_0);
                        temps.push(data[i].tod_3);
                        temps.push(data[i].tod_6);
                        temps.push(data[i].tod_9);
                        temps.push(data[i].tod_12);
                        temps.push(data[i].tod_15);
                        temps.push(data[i].tod_18);
                        temps.push(data[i].tod_21);
                        temps.push(data[i].tom_0);
                        temps.push(data[i].tom_3);
                        temps.push(data[i].tom_6);
                        flag=true;
                        break;
                    }
                }
                ////if there is not data of selected date, and today is Friday, using medium_term_temperature.csv file
                if(flag==false){
                    d3.csv("static/data/medium-term-temperature.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(lt_data){
                        temps=[];
                        for(i=0;i<lt_data.length;i++){
                            var time_in_data = new Date(lt_data[i].time.replace(/-/g,"/"));
                            if((time_in_data - opt_date) / 36e5 / 24 == 0){
                                temps.push(lt_data[i].yes_min);
                                temps.push(lt_data[i].yes_min);
                                temps.push(lt_data[i].yes_min);
                                temps.push(lt_data[i].tod_min);
                                temps.push(lt_data[i].tod_min);
                                temps.push(lt_data[i].tod_min);
                                temps.push(lt_data[i].tod_average);
                                temps.push(lt_data[i].tod_max);
                                temps.push(lt_data[i].tod_max);
                                temps.push(lt_data[i].tod_max);
                                temps.push(lt_data[i].tod_average);
                                temps.push(lt_data[i].tom_min);
                                temps.push(lt_data[i].tom_min);
                                temps.push(lt_data[i].tom_min);
                                break;
                            }
                        }
                        for(i=0;i<temps.length;i++){
                            txts[i].value=temps[i];
                        }
                        if(press_!=null){
                            document.getElementById("txt-pressure").value=press_;
                        }else{
                            document.getElementById("txt-pressure").value="";
                        } 
                    }); 
                }
                
                
                //// if there is data, just fill up
                if(flag==true){
                    for(i=0;i<temps.length;i++){
                        txts[i].value=temps[i];
                    }
                    if(press_!=null){
                        document.getElementById("txt-pressure").value=press_;
                    }else{
                        document.getElementById("txt-pressure").value="";
                    } 
                } 
            });
        });
    });
    //// calculate power generation using valina function
    $(function(){
        $('#form_submit').click(function(){
            $("#warning-message").html("");
            
            if(form_validation()==true){
                $.ajax({
                    url: '/inference',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response){
                        /////////// successfully calculated/////////////////
                        data = JSON.parse(response);
                        temperature_col =  data.temperature;
                        
                        for(i=0;i<34;i++){
                            $(gt_generate_name_list[i]).html(Math.round(data.gt_generate_predicted[i]));
                            $(cc_generate_name_list[i]).html(Math.round(data.cc_generate_predicted[i]));
                            $(gt_send_name_list[i]).html(Math.round(data.gt_transfer_predicted[i]));
                            $(cc_send_name_list[i]).html(Math.round(data.cc_transfer_predicted[i]));
                            /// returned pressure is a number, convert to array for plotting graph
                            pressure.push(data.pressure);
                        };
                        if (current_tab=="gt"){
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
                            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }else{
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
                            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }
                        
                    },
                    error: function(error){
                        if (error.status == 500){
                            alert("산출 실패하였습니다. 오류: 500 파일 존재하지 않습니다. 업데이트 필요합니다. ");
                        }else{
                            alert("산출 실패하였습니다. 오류: " + (error.statusText));
                        }
                        
                    }
                });
            }
        });
    }); 
    ///function to calculate difference between 2 date (in month)
    function monthDiff(dateFrom, dateTo) {
        return dateTo.getMonth() - dateFrom.getMonth() + (12 * (dateTo.getFullYear() - dateFrom.getFullYear()))
    };
    ///// when the tab changed, modify the display content
    $(function gt_tab_selected(){
        $("#tab-GT").click(function(){
            current_tab = "gt";
            if (data==null){
                alert("먼저 산출하세요!");
            }
            ////// draw generated power + temperature + barometric pressure graph
            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
        });
    });

    $(function cc_tab_selected(){
        $("#tab-CC").click(function(){
            current_tab="cc";
            if (data==null){
                alert("먼저 산출하세요!");
            }
            ///// redraw graph
            ////// draw generated power + temperature + barometric pressure graph
            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
        });
    });


    ///function to calculate mean of array
    function mean(array){
        var sum=0;
        for(i=0;i<array.length;i++){
            sum+=array[i];
        }
        return sum/array.length
    }
    /// and sum of it
    function sum(array){
        var sum=0;
        for(i=0;i<array.length;i++){
            sum+=array[i];
        }
        return sum
    }

    ///// schedule calculation, if today is Friday, and there is no data in temperature.csv
    $(function(){
        $('#schedule-submit').click(function(){
            $("#warning-message").html("");
            if(form_validation()==true){
                // var user = $('#inputUsername').val();
                // var pass = $('#inputPassword').val();
                $.ajax({
                    url: '/schedule-ml-inference',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response){
                        /////////// successfully calculated/////////////////
                        data = JSON.parse(response);
                        temperature_col =  data.temperature;
                        for(i=0;i<34;i++){
                            $(gt_generate_name_list[i]).html(Math.round(data.gt_generate_predicted[i]));
                            $(cc_generate_name_list[i]).html(Math.round(data.cc_generate_predicted[i]));
                            $(gt_send_name_list[i]).html(Math.round(data.gt_transfer_predicted[i]));
                            $(cc_send_name_list[i]).html(Math.round(data.cc_transfer_predicted[i]));
                             /// returned pressure is a number, convert to array for plotting graph
                             pressure.push(data.pressure);
                        };
                        
                        if (current_tab=="gt"){
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
                            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }else{
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
                            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }
                    },
                    error: function(error){
                        if (error.status == 500){
                            alert("산출 실패하였습니다. 오류: 500 파일 존재하지 않습니다. 업데이트 필요합니다. ");
                        }else{
                            alert("산출 실패하였습니다. 오류: " + (error.statusText));
                        }
                        
                    }
                });
            }

        });
    });
    var $j = jQuery.noConflict();
    $j( function() {
        $("#date-select").datepicker({ dateFormat: 'yy-mm-dd' });
    });

    //// each time uploading csv files
    $(function(){
        $("#file").change(function(){
            if(check_ext()){
                var form_data = new FormData($("#form")[0]);
                $.ajax({
                    url: '/uploadss',
                    // data: $('form').serialize(),
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    cache: false,
                    processData: false,
                    async: false,
                    success: function(response){
                        if(response == "file uploaded successfully"){
                            alert("정상 처리 되었습니다.");
                        }else if (response =="filename is not acceptable"){
                            alert("파일 이름 일치하지 않기로 파일 업데이드 실패하였습니다.");
                        }
                        var txts = document.getElementsByClassName("temperature-input-textbox");
                        document.getElementById("txt-pressure").value="";
                        for(i=0;i<txts.length;i++){
                            txts[i].value="";
                        }
                        var select_element = document.getElementById("date-select");
                        var opt = select_element.value;
                        d3.csv("static/data/inlet_clean_info.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
                            var today = new Date();
                            var clean_time = data[0].cleaned_time;
                            $("#nearest_cleaned_time").html(clean_time);

                            var clean_time = data[0].cleaned_time.replace(/-/g,"/");
                            clean_time = new Date(clean_time);
                            var hours = Math.abs(today - clean_time) / 36e5;
                            hours = Math.round(hours);
                            
                            $("#EOH").html(hours);


                            var tested_power = data[0].tested_power_output;
                            tested_power = Math.floor(tested_power*1000)/1000;
                            $("#test_power").html(tested_power);
                        });

                        d3.csv("static/data/temperature.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
                            var temps=[];
                            var press_;
                            var opt_date = new Date(opt.replace(/-/g,"/"));
                            for (i=0;i<data.length;i++){
                                time_in_data = new Date(data[i].time.replace(/-/g,"/"));

                                if ((time_in_data - opt_date) / 36e5 / 24 ==0){
                                    press_=data[i].pressure;
                                    temps.push(data[i].yes_15);
                                    temps.push(data[i].yes_15);
                                    temps.push(data[i].yes_15);
                                    temps.push(data[i].tod_0);
                                    temps.push(data[i].tod_3);
                                    temps.push(data[i].tod_6);
                                    temps.push(data[i].tod_9);
                                    temps.push(data[i].tod_12);
                                    temps.push(data[i].tod_15);
                                    temps.push(data[i].tod_18);
                                    temps.push(data[i].tod_21);
                                    temps.push(data[i].tom_0);
                                    temps.push(data[i].tom_3);
                                    temps.push(data[i].tom_6);
                                }
                            }
                            for(i=0;i<temps.length;i++){
                                txts[i].value=temps[i];
                            }
                            if(press_!=null){
                                document.getElementById("txt-pressure").value=press_;
                            }else{
                                document.getElementById("txt-pressure").value="";
                            }
                        });

                    },
                    error: function(error){
                        if (error.status == 500){
                            alert("산출 실패하였습니다. 오류: 500 파일 존재하지 않습니다. 업데이트 필요합니다. ");
                        }else{
                            alert("산출 실패하였습니다. 오류: " + (error.statusText));
                        }
                        
                    }
                });
            }
        });
    });
    
    
    ///form validatioon function
    function form_validation(){
        var textbox_list = document.getElementsByClassName('temperature-input-textbox');
        var array=[];
        var error = true;
        for (i=0;i<textbox_list.length;i++){
            array.push(textbox_list[i]);
        }
        array.forEach(function(element) {
            if (element.value==''){
                $("#warning-message").html("* 온도를 입력해 주세요!");
                error = false;
                return error;
            }else if(-50>element.value || element.value>70){
                $("#warning-message").html("* 온도는 -50~70도 입니다!");
                error = false;
                return error;
            }
        });
        
        var textbox_pressure = document.getElementById("txt-pressure");
        if (800>textbox_pressure.value || textbox_pressure.value>1200){
            $("#warning-message").html("* 대기압은 800~1200 mbar 입니다!");
            error = false;
            return error;
        }else if (textbox_pressure.value==""){
            $("#warning-message").html("* 대기압을 입력해 주세요!");
            error = false;
            return error;
        }
        var textbox_cleaned_time = document.getElementById("txt-cleaned-time");
        if (textbox_cleaned_time.value<0){
            $("#warning-message").html("* 수세정후 시간은 음수 아닙니다!");
            error = false;
            return error;
        }else if (textbox_cleaned_time.value==""){
            $("#warning-message").html("* 수세정후 시간을 입력해 주세요!");
            error = false;
            return error;
        }
        if (isNaN(Date.parse(document.getElementById('date-select').value))){
            
            $("#warning-message").html("* 거래일자는 날짜 포맷입니다!");
            error = false;
            return error;
        }else{
            if(document.getElementById('date-select').value.split('-').length<3){
                $("#warning-message").html("* 거래일자는 날짜 포맷입니다!");
                error = false;
                return error;
            }
        }
        return error;
        
    };



    //checking for valid number 
    $(document).on('change', '.temperature-input-textbox', function() { 
        var input_value = parseFloat($(this).val());
        if(isNaN(input_value)) { input_value = 0; }
        $(this).val(input_value);
    });
    $(document).on('change', '.textbox-input', function() { 
        var input_value = parseFloat($(this).val());
        if(isNaN(input_value)) { input_value = 0; }
        $(this).val(input_value);
    });
    
    //clear textbox everytime click on it
    $(document).on('focus', '.temperature-input-textbox', function() {
        $(this).val('');
    });
    $(document).on('focus', '#txt-pressure', function() { 
        $(this).val('');
    });

    ////function display the realtime clock
    function display_time(){
        var interval=1000 /// 1second interval;
        time = setTimeout('display_clock()',interval)
    };


    function display_clock(){
        var date = new Date();
        time = pad2(date.getHours( ))+ ":" +  pad2(date.getMinutes()) + ":" +  pad2(date.getSeconds());
        $('#clock').html(time)
        display_time();
    };

    
    //// function to add 0 ahead of single number
    function pad2(number) {
        return (number < 10 ? '0' : '') + number
    };

    //// create a list of dates from startDate to endDate
    var today = new Date();
    //var startDate = new Date(today.getFullYear(), 0, 1);
    var startDate = today;
    var endDate = new Date(today.getFullYear(),today.getMonth(),today.getDate()+72); //YYYY-MM-DD
    //// function to generate dates list
    var getDateArray = function(start, end) {
        var arr = new Array();
        var dt = new Date(start);
        while (dt <= end) {
            arr.push(new Date(dt).toISOString().split("T")[0]);
            dt.setDate(dt.getDate() + 1);
        }
        /// add the last day of year
        arr.push(new Date(dt).toISOString().split("T")[0]);
        return arr
    }
    //// listup the dates
    datesList = getDateArray(startDate, endDate);
    ///// generate tables
    $(document).ready(function(){
        $("#export-to-csv-button").click(function(){
            if (temperature_col==null){
                alert("먼저 산출하세요!");
                return;
            }else{
                document.getElementById("export-to-csv").click();
            }
            
        });
        $("#export-to-csv").on('click', function (event) {
            var selected_date = document.getElementById("date-select").value.replace(/-/g,"")
            var filename = "bid_2637_" + selected_date + ".csv";
            exportTableToCSV.apply(this, [$('#data-table'),temperature_col, filename]);
        });
        ///// convert weekday from int to hangul text
        var date = new Date();
        year = date.getFullYear();
        month= date.getMonth()+1;
        day=date.getDate();
        weekday = date.getDay();
        if (weekday==1){
            wd ='월요일';
        }else if (weekday==2){
            wd ='화요일';
        }else if (weekday==3){
            wd ='수요일';
        }else if (weekday==4){
            wd ='목요일';
        }else if (weekday==5){
            wd ='금요일';
        }else if (weekday==6){
            wd ='토요일';
        }else{
            wd ='일요일';
        }
        //display on site
        $('#div-info-date').html(year +'년 '+month+'월 '+day+'일, ' + wd);
        // today = pad2(year)+"-"+pad2(month)+"-"+pad2(day)
        // // $('#date-select').empty();
        // $.each(datesList, function(i, p) {
        //     if (today === p){
        //         $('#date-select').append($('<option selected="selected"></option>').val(p).html(p));
        //     }else{
        //         $('#date-select').append($('<option></option>').val(p).html(p));
        //     }
        // });

        //// draw calculated table
        table_body = "<tr>";
        table_body+="<td>구분</td>";
        table_body+="<td>거래 시간</td>";
        hour = 17;
        for(i=0;i<34;i++){
            hour +=1;
            if(Math.floor(hour/24)<1){
                table_body+="<td>-"+pad2(hour%24)+"01</td>";
            }else if(Math.floor(hour/24)==1){
                table_body+="<td>"+pad2(hour%24)+"01</td>";
            }else{
                table_body+="<td>+"+pad2(hour%24)+"01</td>";
            }
        };
        
        $('#generated-output-data-head').html(table_body);
        table_body = "" ;
        var table_body_gt="<tr><th rowspan='2'>송전단</th><th>GT</th>";
        var table_body_cc="<tr><th>CC</th>";
        hour=0;
        for(i=0;i<34;i++){
        hour +=1;
            table_body_gt+="<td name='send-power-gt--"+pad2(hour)+"' id='send-power-gt--"+pad2(hour)+"'></td>";
            table_body_cc+="<td name='send-power-cc--"+pad2(hour)+"' id='send-power-cc--"+pad2(hour)+"'></td>";
        };
        table_body_gt+="</tr>";
        table_body_cc+="</tr>";
        table_body += table_body_gt+table_body_cc;
        var table_body_gt_="<tr><th rowspan='2'>발전단</th><th>GT</th>";
        var table_body_cc_="<tr><th>CC</th>";
        hour=0;
        for(i=0;i<34;i++){
            hour +=1;
            table_body_gt_+="<td name='generated-power-gt--"+pad2(hour)+"' id='generated-power-gt--"+pad2(hour)+"'></td>";
            table_body_cc_+="<td name='generated-power-cc--"+pad2(hour)+"' id='generated-power-cc--"+pad2(hour)+"'></td>";     
        };
        table_body_gt_+="</tr>";
        table_body_cc_+="</tr>";
        table_body += table_body_gt_+table_body_cc_;
        $('#generated-output-data').html(table_body);
            ////// draw temperature table
        table_body = "" 
        hour = 12
        for(i=0;i<14;i++){
                hour +=3
                if(Math.floor(hour/24)<1){
                    table_body+="<tr><td width='20%'>-"+pad2(hour%24)+"</td><td><input name='input-temp--"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }else if(Math.floor(hour/24)==1){
                    table_body+="<tr><td width='20%'>"+pad2(hour%24)+"</td><td><input name='input-temp-"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }else{
                    table_body+="<tr><td width='20%'>+"+pad2(hour%24)+"</td><td><input name='input-temp--"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }
            };
        $('#input-temperature').html(table_body);
    });

    function check_ext(){
        var regexp;
        var file_element = document.getElementById("file")
        var extension =     file_element.value.substr(file_element.value.lastIndexOf('.'));
        if ((extension.toLowerCase() != ".csv") && (extension != "")){
            alert("csv 포맷만 업로드 가능합니다.");
            theForm.file.focus();
            return false;
        }
        return true;
    }
</script>
</head>
<body onload=display_time();>
<div id="wrapper">
    <!-- left container-->
    <div id="left-container">
        <div id="div-logo">
            <img src="static/icons/kospo_logo.png" width="100%" height ="auto"/>
        </div>
        <hr/><hr/><hr/>
        <div id="div-system-infos">
                <div id="div-info-station">
                        <span style="display:block;font-weight:bolder; font-size:xx-large; color:rgb(188, 238, 89)">안동발전본부</span>
                </div>
                <hr/>
                <div id="div-info-date">
                    Systenm's info
                </div>
                <hr/>
                <div id="div-info-clock">
                    <span>현재시간:</span>
                    <span id="clock"></span>
                </div>
                <hr/>
                <div id="div-info-nearest-clean-time">
                    <span>최근 수세정:</span>
                    <span id="nearest_cleaned_time" ></span>
                </div>
        </div>
        <hr/>
        <div id="div-menu-items">
                <div class="info" style="margin-top: 30px">
                    <div width="100%">수세정후 시험 출력 (MW) </div>
                    <div class="text-temp">
                        <div id="test_power"></div>
                    </div>
                        
                </div>
    
    
                <div class="info" style="margin-top: 30px">
                    <div width="100%"> 수세정후 시간 (Hours) </div>
                    <div class="text-temp">
                        <div id="EOH"></div>
                    </div>
                    
                </div>
            
    
        </div>
    </div>


    <!-- right container-->
    <div id="graph-container">
        <div id="graph-upper-container">
            <form role="form" id="form" name="input_form" method="POST" enctype="multipart/form-data">
                    <div class="div-input" id="div-date-input">
                        <div class="upper-input"> <input type="text" id="date-select" data-date-format="yyyy/mm/dd" name="date-select"></div>
                        <div id="div-temperature-input" class="lower-element">
                            <table class="table-input table" id="table-temperature-input">
                                <thead>
                                    <tr>
                                        <td><span style="font-weight: bold;">시간</span></td>
                                        <td><span style="font-weight: bold;">온도</span></td>
                                    </tr>
                                </thead>
                                <tbody id="input-temperature">
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="div-output" id="div-power-output-wrapper">
                        <div class="upper-input" id="div-pressure-cleaned-input">
                            <div id="div-pressure-input" style="float:left;margin: 0 10px; max-width: 20%;" >
                                <span class="label-input">대기압 (mbar):</span> 
                                <input name="txt-pressure" id="txt-pressure" class="textbox-input" type="text"/>
                            </div>
                            <div id="div-cleaned-time-input" style="float:left;margin: 0 10px;max-width: 20%;">
                                <span class="label-input">수세정후 운영 시간 (hr):</span> 
                                <input name="txt-cleaned-time" id="txt-cleaned-time" class="textbox-input" type="text"/>
                            </div>
                            <div style="float:left; height:100%">
                                <input name="file" type="file" id="file" style="display:none;" accept=".csv"/>
                                <button class="button" type="button" name="csv" id="csv">파일 업로드</button>
                                <button class="button" type="reset" name="reset" onclick="reset_table();">다시 입력</button>
                                <button class="button" type="button" name="ml-submit" id="ml-form_submit">ML 산출</button>
                                <button class="button" type="button" name="submit" id="form_submit">수식 산출</button>
                                <button class="button" type="button" name="schedule" id="schedule-submit">예약 산출</button>
                                <button class="button" type="button" name="export" id="export-to-csv-button">csv 생성</button>
                                <button class="button" type="button" name="dnl-template" id="dnl-template">파일 양식 다운로드</button>
                                <a href="#" id="export-to-csv" style="display:none"></a>
                            </div>
                            
                        </div>
                        <div id="div-power-output" class="lower-element">
                            <table class="data-table table" id="data-table" >
                                <thead style="height:12%" id="generated-output-data-head">
                                </thead>
                                <tbody id="generated-output-data">
                                </tbody>
                            </table>
                        </div>

                        <div class="button-inlet-type">
                                <span id='warning-message'></span>
                        </div>
                    </div>
            </form>
        </div>
        <div id="graph-lower-container" style="max-height:582px">
            <!-- container of 발전-송전 그림과 출력저하 그림 -->
            <div id="left-graph-container" style="height:auto">
                <div class="button-inlet-type"><button class="tab-button" id="tab-GT" onclick="activeTabButton(event, 'GT')">GT</button><button class="tab-button" id="tab-CC" onclick="activeTabButton(event, 'CC')">CC</button></div>
                <div style="display:inline-block; width:100%;">
                    <div id="div-power-loss-graph" class="graph" style="width:95%; height:500px;">출력저하 그림</div>
                </div>
                
            </div>
            <div id="right-graph-container"> 
                <!-- container of 산출 발전량 그림-->
                <div id="div-calculated-output-graph">산출 발전량 그림</div>
            </div>
        </div>
    </div>
</div>



<!-- draw highchart graphs-->
<script>
    /// Highcharts injection modules
    //// demo data
    // var output=[428.6349792,428.6349792,429.3438721,428.2450562,427.8551636,427.8551636,428.4931946,428.4931946,428.9539795,428.5995178,427.6070557,427.6070557,428.8476563,428.8476563,429.3084412,429.3084412,428.6704102,428.6704102,428.6349792,428.6349792,428.6349792,428.6349792,428.7058716,428.7058716,428.6349792,428.6349792,429.1666565,429.1666565,428.9539795,428.2096252,428.2096252,428.0678406,428.2096252,429.3438721,429.1666565,428.2096252,428.4577332,428.6349792,428.6349792,428.5995178,428.4223022,427.8197327,427.890625,427.890625,428.4223022,427.9969482,428.9539795,428.4931946,428.4931946,428.4931946] /// generated power outpu
    function draw_power_reduction(power_reduction_serie){
        Highcharts.chart('div-power-loss-graph', {
            chart: {
                type: 'line',
                style:{
                    fontFamily:'sans-serif'
                }
            },
            title: {
                text: '출력저하',
                style:{
                    fontWeight:'Bold'
                }
            },
            xAxis: {
                categories: ['0시', '1시', '2시', '3시', '4시', '5시','6시', '7시', '8시', '9시', '10시', '11시', '12시', '13시', '14시', '15시', '16시', '17시', '18시', '19시', '20시', '21시', '22시', '23시']
            },
            yAxis: {
                title: {
                    text: '전력 (MW)'
                }
            },
            tooltip: {
                headerFormat: '<b>출력 저하량</b><br/>',
                pointFormat: '{series.name}: {point.y}'
            },
            plotOptions: {
                line: {
                dataLabels: {
                    enabled: true,
                    formatter: function () {
                        return parseFloat(this.y.toFixed(2)).toLocaleString()
                    }
                },
                enableMouseTracking: false
                }
            },
            series: [{
                name: '산출 출력저하',
                data: power_reduction_serie,
            }]
        });
    };
    function draw_output(serie_1, serie_2, serie_3, power_min, date){
        //// draw output graph
        Highcharts.chart('div-calculated-output-graph', {
            chart: {
                zoomType: 'xy',
                style:{
                    fontFamily:'sans-serif'
                }
            },
            plotOptions: {
                column: {
                    stacking: 'normal',
                    dataLabels: {
                        enabled: true,
                        formatter: function () {
                            return parseFloat(this.y.toFixed(2)).toLocaleString()
                        }
                    }
                }
            },
            title: {
                text: '산출 발전량 - ' + date,
                align: 'center',
                style:{
                    fontWeight:'Bold'
                }
            },
            xAxis: [{
                categories: ['0시', '1시', '2시', '3시', '4시', '5시','6시', '7시', '8시', '9시', '10시', '11시', '12시', '13시', '14시', '15시', '16시', '17시', '18시', '19시', '20시', '21시', '22시', '23시'],
                crosshair: true
            }],
            yAxis: [{ // Primary yAxis
                labels: {
                    format: '{value}°C',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                title: {
                    text: '온도',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                opposite: true

            }, { // Secondary yAxis
                min: power_min,
                gridLineWidth: 0,
                title: {
                    text: '발전량',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                },
                labels: {
                    format: '{value} MW',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    },
                    shadow: false,
                    enabled: false,
                }

            }, { // Tertiary yAxis
                gridLineWidth: 0,
                title: {
                    text: '대기압',
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    },
                    shadow: false
                },
                labels: {
                    format: '{value} mb',
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    },
                    shadow: false
                },
                opposite: true
            }],
            tooltip: {
                shared: true
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                x: 80,
                verticalAlign: 'top',
                y: 55,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || 'rgba(255,255,255,0.25)',
                shadow: false
            },
            series: [{
                name: '발전출력',
                type: 'column',
                yAxis: 1,
                data: serie_1,
                tooltip: {
                valueSuffix: ' MW'
                }
            }, {
                name: '대기압',
                type: 'spline',
                yAxis: 2,
                data: serie_3,
                marker: {
                enabled: false
                },
                dashStyle: 'shortdot',
                tooltip: {
                valueSuffix: ' mbar'
                }

            }, {
                name: '온도',
                type: 'spline',
                data: serie_2,
                tooltip: {
                valueSuffix: ' °C'
                }
            }],
            responsive: {
                rules: [{
                condition: {
                    maxWidth: 500
                },
                chartOptions: {
                    legend: {
                    floating: false,
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom',
                    x: 0,
                    y: 0
                    }
                }
                }]
            }
        });
    };
    var serie_1=[409.9, 341.5, 350.4, 419.2, 402.0, 421.0, 435.6, 417.5, 411.4, 434.1, 375.6, 350.4,409.9, 341.5, 350.4, 419.2, 402.0, 421.0, 435.6, 417.5, 411.4, 434.1, 375.6, 350.4];
    var serie_2=[7.0, 6.9, 7.5, 7.5, 8.2,  8.3, 9.3, 11.9,15.2, 16.5, 16.3, 18.3, 19.6,17.0, 18.9, 17.5, 14.5, 13.2, 13.5,  12.9,11.5, 9.2, 8.5, 7.6];
    var serie_3=[1016, 1016, 1015.9, 1015.5, 1012.3, 1009.5, 1009.6, 1010.2, 1013.1, 1016.9, 1018.2, 1016.7,1016, 1016, 1015.9, 1015.5, 1012.3, 1009.5, 1009.6, 1010.2, 1013.1, 1016.9, 1018.2, 1016.7];
    
    draw_power_reduction([2.7,3.9,4.2,4.8,5.7,6.6,6.9,8.5,9.5,9.6,10.3,11.9,13.9,14.2,14.5,15.2,16.6,17,18.3,18.4,21.5,23.3,25.2,26.5])
    
    draw_output(serie_1, serie_2, serie_3, 300.1, '2019-01-01');
</script>
</body>